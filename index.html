<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>A New Decade of Joy & Deep Meaning</title>
    <link rel="icon" type="image/png" href="https://ik.imagekit.io/cbctech/favicon.png?updatedAt=1757847359360">
    
    <!-- EmailJS SDK -->
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    
    <!-- Standard Meta Description -->
    <meta name="description" content="Shafira's holistic planner for the 'Company of One' CEO of Cetalabs. Bismillah.">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #fff0f5 0%, #fdf2f8 100%);
            padding: 20px;
            line-height: 1.6;
            color: #4a044e;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding-bottom: 50px;
        }
        
        header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px 0;
        }
        
        h1 {
            font-size: 2.2rem;
            color: #9d174d;
            margin-bottom: 10px;
        }
        
        .subtitle, a {
            font-size: 1.1rem;
            color: #be185d;
            opacity: 0.8;
            text-decoration: none;
        }
        
        a:hover { text-decoration: underline; }

        /* --- CONTROLS BAR --- */
        .controls-bar {
            background: white;
            padding: 15px 20px;
            border-radius: 12px;
            margin-bottom: 30px;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 15px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.05);
            border: 1px solid #fbcfe8;
            flex-wrap: wrap;
        }

        .life-stage-select {
            padding: 10px 15px;
            border-radius: 8px;
            border: 1px solid #db2777;
            background: #fff0f5;
            color: #9d174d;
            font-weight: bold;
            cursor: pointer;
            font-size: 1rem;
        }

        /* --- PARTNER SYNC PANEL --- */
        .partner-sync-panel {
            background: #fff;
            border-radius: 12px;
            border: 1px solid #f9a8d4;
            padding: 15px 20px;
            margin-top: 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 20px;
            flex-wrap: wrap;
        }

        .sync-info {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 0.9rem;
        }

        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 44px;
            height: 22px;
        }

        .toggle-switch input { opacity: 0; width: 0; height: 0; }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0; left: 0; right: 0; bottom: 0;
            background-color: #cbd5e1;
            transition: .4s;
            border-radius: 34px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 16px; width: 16px;
            left: 3px; bottom: 3px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .slider { background-color: #db2777; }
        input:checked + .slider:before { transform: translateX(22px); }

        .btn-sync-now {
            background: #be185d;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: 600;
            cursor: pointer;
            font-size: 0.85rem;
            transition: 0.2s;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .btn-sync-now:hover { background: #9d174d; transform: scale(1.02); }
        .btn-sync-now:disabled { background: #cbd5e1; cursor: not-allowed; }

        /* --- COLLAPSIBLE CYCLE WIDGET --- */
        .cycle-widget-container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 10px 25px rgba(219, 39, 119, 0.15);
            margin-bottom: 40px;
            border: 2px solid #fbcfe8;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .cycle-header {
            padding: 15px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            background: #fff0f5;
        }

        .cycle-header:hover { background: #fce7f3; }

        .cycle-summary {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .cycle-summary h3 { margin: 0; color: #831843; font-size: 1.1rem; }
        
        .cycle-body {
            padding: 20px 30px;
            display: block; 
        }
        .cycle-body.collapsed { display: none; }

        .cycle-controls {
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 20px;
        }

        .cycle-phase-badge {
            display: inline-block;
            padding: 5px 12px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .phase-menstrual { background: #fce7f3; color: #be185d; border: 1px solid #fbcfe8; }
        .phase-follicular { background: #dcfce7; color: #15803d; border: 1px solid #bbf7d0; }
        .phase-ovulatory { background: #fef9c3; color: #a16207; border: 1px solid #fde047; }
        .phase-luteal { background: #ffedd5; color: #c2410c; border: 1px solid #fed7aa; }

        .cycle-progress-container {
            flex-grow: 1;
            max-width: 400px;
            margin: 0 20px;
        }
        .cycle-bar-bg { background: #f3f4f6; height: 10px; border-radius: 10px; overflow: hidden; }
        .cycle-bar-fill { height: 100%; background: #db2777; width: 0%; transition: width 0.5s; }
        .cycle-labels { display: flex; justify-content: space-between; font-size: 0.75rem; color: #9ca3af; margin-top: 5px; }

        .preview-bar {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px dashed #f9a8d4;
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }

        .preview-btn {
            font-size: 0.8rem;
            padding: 6px 12px;
            border-radius: 15px;
            border: 1px solid #e5e7eb;
            background: white;
            cursor: pointer;
            color: #6b7280;
        }
        .preview-btn:hover { background: #f3f4f6; }
        .preview-btn.active-preview { background: #fce7f3; color: #be185d; border-color: #fbcfe8; font-weight: bold; }
        
        .reset-btn {
            font-size: 0.8rem;
            padding: 6px 12px;
            background: #be185d;
            color: white;
            border: none;
            border-radius: 15px;
            cursor: pointer;
            margin-left: auto;
        }

        /* --- Season Tabs --- */
        .tabs {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-bottom: 40px;
            flex-wrap: wrap;
        }

        .tab-btn {
            padding: 12px 25px;
            border: none;
            border-radius: 30px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            background: white;
            color: #64748b;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
            border: 2px solid transparent;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .tab-btn:hover { transform: translateY(-2px); }
        .tab-btn.active { color: white; box-shadow: 0 8px 15px rgba(157, 23, 77, 0.2); }

        .tab-nurture.active { background: #059669; border-color: #059669; }
        .tab-balance.active { background: #2563eb; border-color: #2563eb; }
        .tab-sprint.active { background: #7c3aed; border-color: #7c3aed; }

        /* --- Grid Layout --- */
        .dashboard-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 40px;
        }

        .departments-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
        }

        .dept-card {
            background: white;
            border-radius: 16px;
            padding: 25px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.03);
            border-top: 5px solid #ccc;
            transition: transform 0.2s;
            height: 100%;
            display: flex;
            flex-direction: column;
        }
        .dept-card:hover { transform: translateY(-5px); }
        .dept-icon { font-size: 1.8rem; margin-bottom: 10px; display: block; }
        .dept-title { font-size: 1.2rem; font-weight: 700; color: #1e293b; margin-bottom: 5px; }
        .dept-focus { font-size: 0.85rem; text-transform: uppercase; letter-spacing: 0.5px; font-weight: 600; margin-bottom: 15px; display: block;}
        
        .dept-okr-list { list-style: none; margin-bottom: 20px; flex-grow: 1; }
        .dept-okr-list li {
            margin-bottom: 10px;
            font-size: 0.9rem;
            color: #475569;
            padding-left: 15px;
            border-left: 2px solid #e2e8f0;
        }

        .creative-win-box {
            background: #fdf4ff;
            border: 1px dashed #d946ef;
            border-radius: 10px;
            padding: 12px;
            margin-top: auto;
        }
        .win-title { font-size: 0.75rem; font-weight: bold; color: #a21caf; text-transform: uppercase; display: block; margin-bottom: 5px; }
        .win-text { font-size: 0.9rem; color: #86198f; font-style: italic; }
        
        .dept-biz { border-color: #f59e0b; } .dept-biz .dept-focus { color: #d97706; }
        .dept-self { border-color: #10b981; } .dept-self .dept-focus { color: #059669; }
        .dept-marriage { border-color: #ec4899; } .dept-marriage .dept-focus { color: #db2777; }
        .dept-baby { border-color: #3b82f6; } .dept-baby .dept-focus { color: #2563eb; }
        .dept-family { border-color: #8b5cf6; } .dept-family .dept-focus { color: #7c3aed; }

        .schedule-container {
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.05);
        }

        .time-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 15px;
        }

        .time-card {
            padding: 15px;
            border-radius: 12px;
            text-align: center;
            border: 1px solid #f1f5f9;
            position: relative;
        }

        .ctx-biz { background: #fff7ed; color: #c2410c; border-color: #ffedd5; }
        .ctx-self { background: #f0fdf4; color: #15803d; border-color: #dcfce7; }
        .ctx-baby { background: #eff6ff; color: #1d4ed8; border-color: #dbeafe; }
        .ctx-family { background: #faf5ff; color: #7e22ce; border-color: #f3e8ff; }

        .protocols-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 25px;
        }
        .protocol-card { background: white; padding: 25px; border-radius: 16px; box-shadow: 0 4px 15px rgba(0,0,0,0.03); }
        .protocol-title { font-size: 1.1rem; font-weight: 700; margin-bottom: 15px; color: #334155; padding-bottom: 10px; border-bottom: 2px solid #f1f5f9; }
        
        .cl-item { display: flex; align-items: flex-start; gap: 10px; margin-bottom: 12px; font-size: 0.9rem; color: #475569; }
        .cl-badge { font-size: 0.7rem; padding: 2px 6px; border-radius: 4px; background: #e2e8f0; color: #64748b; flex-shrink: 0; margin-top: 2px; }

        @media (max-width: 900px) {
            .protocols-grid { grid-template-columns: 1fr; }
            .time-grid { grid-template-columns: 1fr 1fr; }
            .cycle-controls { flex-direction: column; align-items: flex-start; }
            .cycle-progress-container { width: 100%; margin: 15px 0; }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Holistic CEO Dashboard</h1>
            <p class="subtitle">Company of One ‚Ä¢ Spiritual Alignment ‚Ä¢ Cycle Synced</p>
            <p style="margin-top: 10px;">
                <a href="https://webdevsha.github.io/future-mom-rev/slider.html">Income & Retirement Calc</a> | 
                <a href="https://webdevsha.github.io/future-mom-rev/okr.html">Detailed OKR View</a>
            </p>
        </header>

        <!-- CONTROLS BAR: Life Stage -->
        <div class="controls-bar">
            <label style="color:#831843; font-weight:600;">Current Chapter:</label>
            <select id="lifeStageSelect" class="life-stage-select" onchange="updateLifeStage()">
                <option value="preparing" selected>üå± Preparing for Pregnancy (Health & Calm)</option>
                <option value="pregnancy">ü§∞ Pregnancy (Nesting)</option>
                <option value="parenting">üë∂ Parenting (Guide)</option>
                <option value="parenting_pregnant">ü§± Parenting + Pregnant (Supermom Mode)</option>
            </select>
        </div>

        <!-- COLLAPSIBLE CYCLE WIDGET -->
        <div class="cycle-widget-container">
            <div class="cycle-header" onclick="toggleWidget()">
                <div class="cycle-summary">
                    <h3>Biology Status:</h3>
                    <span id="headerPhaseBadge" class="cycle-phase-badge phase-menstrual">...</span>
                    <span>Day <strong id="headerDayVal">1</strong></span>
                </div>
                <div class="toggle-icon" id="widgetIcon">‚ñº</div>
            </div>

            <div class="cycle-body" id="cycleBody">
                <div class="cycle-controls">
                    <div style="flex: 1;">
                        <span id="fullPhaseBadge" class="cycle-phase-badge phase-menstrual" style="margin-bottom:10px;">...</span>
                        <div class="cycle-progress-container" style="margin: 0; max-width: 100%;">
                            <div class="cycle-bar-bg">
                                <div id="cycleBar" class="cycle-bar-fill"></div>
                            </div>
                            <div class="cycle-labels">
                                <span>Menstrual</span>
                                <span>Follicular</span>
                                <span>Ovulatory</span>
                                <span>Luteal</span>
                            </div>
                        </div>
                    </div>
                    
                    <div style="text-align: right;">
                        <label style="font-size:0.85rem; color:#64748b; display:block;">Start Date:</label>
                        <input type="date" id="lastPeriodInput" value="2025-12-01" onchange="recalculateTrueCycle()" style="padding: 8px; border-radius: 6px; border:1px solid #ddd;">
                        <div style="font-size:0.8rem; color:#be185d; margin-top:5px;">Next: <span id="nextPeriodDate">...</span></div>
                    </div>
                </div>

                <!-- NEW PARTNER SYNC PANEL -->
                <div class="partner-sync-panel">
                    <div class="sync-info">
                        <label class="toggle-switch">
                            <input type="checkbox" id="autoSyncToggle" checked onchange="saveSyncPrefs()">
                            <span class="slider"></span>
                        </label>
                        <div>
                            <span style="font-weight: 700; color: #831843; display: block;">Auto-Sync with R</span>
                            <span id="syncStatusText" style="color: #64748b; font-size: 0.75rem;">Emails R on Day 1, Ovulation & Day 23</span>
                        </div>
                    </div>
                    <button id="manualSyncBtn" class="btn-sync-now" onclick="sendManualUpdate()">
                        <span>‚úâÔ∏è</span> Send Update to R Now
                    </button>
                </div>

                <div class="preview-bar">
                    <span style="font-size:0.85rem; font-weight:bold; color:#831843;">üëÄ Preview content for:</span>
                    <button class="preview-btn" onclick="previewPhase('menstrual')">Menstrual</button>
                    <button class="preview-btn" onclick="previewPhase('follicular')">Follicular</button>
                    <button class="preview-btn" onclick="previewPhase('ovulatory')">Ovulatory</button>
                    <button class="preview-btn" onclick="previewPhase('luteal')">Luteal</button>
                    <button class="reset-btn" onclick="recalculateTrueCycle()">‚Ü∫ Reset to Today</button>
                </div>
            </div>
        </div>

        <!-- SEASON TABS -->
        <div class="tabs">
            <button class="tab-btn tab-nurture active" onclick="setSeason('nurture')">üå± Season of Nurture (Conservative)</button>
            <button class="tab-btn tab-balance" onclick="setSeason('balance')">‚öñÔ∏è Season of Balance (Moderate)</button>
            <button class="tab-btn tab-sprint" onclick="setSeason('sprint')">üöÄ Season of Sprint (Ambitious)</button>
        </div>

        <div class="dashboard-grid">
            <!-- 1. DEPARTMENTS -->
            <div>
                <div class="section-header">
                    <h2>Quarterly Department OKRs</h2>
                    <div class="section-line"></div>
                </div>
                <div class="departments-container" id="deptContainer">
                    <!-- JS populated -->
                </div>
            </div>

            <!-- 2. DAILY RHYTHM (CYCLE ADJUSTED) -->
            <div>
                <div class="section-header">
                    <h2>The Daily Rhythm</h2>
                    <div class="section-line"></div>
                </div>
                <div class="schedule-container">
                    <div class="cycle-note" id="cycleNote">
                        <!-- JS populated cycle advice -->
                    </div>
                    <div class="time-grid" id="timeGrid">
                        <!-- JS populated schedule -->
                    </div>
                </div>
            </div>

            <!-- 3. PROTOCOLS -->
            <div>
                <div class="section-header">
                    <h2>Routine Protocols</h2>
                    <div class="section-line"></div>
                </div>
                <div class="protocols-grid">
                    <div class="protocol-card" style="border-top: 4px solid #db2777;">
                        <div class="protocol-title">ü©∏ Current Cycle Power Moves</div>
                        <div id="cycleProtocolList"></div>
                    </div>
                    <div class="protocol-card">
                        <div class="protocol-title">Weekly Must-Dos</div>
                        <div id="weeklyList"></div>
                    </div>
                    <div class="protocol-card">
                        <div class="protocol-title">Monthly Reset</div>
                        <div id="monthlyList"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        /* --- 1. CONFIG & CYCLE LOGIC --- */
        let truePhase = 'menstrual'; 
        let displayPhase = 'menstrual'; 
        let trueDay = 1;
        let currentLifeStage = 'parenting'; 
        const cycleLength = 28;

        const lifeStageData = {
            preparing: { id: 'baby', icon: 'üå±', title: 'Preparing', focus: 'Health & Calm', style: 'dept-baby', okrs: ['KR: Daily Folic Acid & Supps', 'KR: Track Cycle Consistently', 'KR: Reduce Stress (Cortisol)', 'KR: Health Checkup'], win: 'Book a "Pre-Baby" couples spa day' },
            pregnancy: { id: 'baby', icon: 'ü§∞', title: 'Pregnancy', focus: 'Nesting & Health', style: 'dept-baby', okrs: ['KR: Hypnobirthing Course', 'KR: Daily Pelvic Floor', 'KR: Nursery Setup', 'KR: Read 1 Birth Book'], win: 'Cast a belly mold or start a pregnancy journal' },
            parenting: { id: 'baby', icon: 'üë∂', title: 'Parenting', focus: 'Connection & Guide', style: 'dept-baby', okrs: ['KR: Daily Sensory Play', 'KR: Bedtime Spiritual Stories', 'KR: Outdoor Nature Walk', 'KR: Toy Rotation'], win: 'Create a "First Words" audio capsule or Photo Book' },
            parenting_pregnant: { id: 'baby', icon: 'ü§±', title: 'Parenting + Pregnant', focus: 'Energy Management', style: 'dept-baby', okrs: ['KR: Sibling Prep Books', 'KR: Outsource Heavy Lifting', 'KR: Nap when Toddler Naps', 'KR: Batch Cook for Postpartum'], win: 'Pack a "Big Brother/Sister" gift box' }
        };

        const cycleData = {
            menstrual: { name: 'Menstrual (Winter)', style: 'phase-menstrual', focus: 'Rest & Spiritual Reflection', note: "Energy is lowest. Prioritize spiritual grounding (Dhikr/Journaling) and deep rest.", adjustments: { morning: { task: 'Gentle Stretch / Prayer', type: 'ctx-self' }, work1: { task: 'Admin/Review (Low Energy)', type: 'ctx-biz' }, work2: { task: 'Learning/Reading', type: 'ctx-biz' }, evening: { task: 'Early Bedtime / Reflection', type: 'ctx-self' } }, powerMoves: [ { badge: 'Biz', text: 'Audit Finances & Metrics' }, { badge: 'Spirit', text: 'Increase Tahajjud/Dua (Reflection)' }, { badge: 'Self', text: 'Magnesium baths & Warm food' } ] },
            follicular: { name: 'Follicular (Spring)', style: 'phase-follicular', focus: 'Plan & Create', note: "Energy rising. Great for brainstorming new features and planning family outings.", adjustments: { morning: { task: 'Cardio / Run', type: 'ctx-self' }, work1: { task: 'Creative Deep Work (Code)', type: 'ctx-biz' }, work2: { task: 'Project Planning', type: 'ctx-biz' }, evening: { task: 'Family Outing / Fun', type: 'ctx-family' } }, powerMoves: [ { badge: 'Biz', text: 'Start new dev features' }, { badge: 'Home', text: 'Deep Clean / Refresh Space' }, { badge: 'Baby', text: 'New sensory play setup' } ] },
            ovulatory: { name: 'Ovulatory (Summer)', style: 'phase-ovulatory', focus: 'Connect & Pitch', note: "Peak energy & magnetism. Host gatherings, pitch clients, and prioritize connection with husband.", adjustments: { morning: { task: 'HIIT / Power Pilates', type: 'ctx-self' }, work1: { task: 'Sales Calls / Recording', type: 'ctx-biz' }, work2: { task: 'Collab / Meetings', type: 'ctx-biz' }, evening: { task: 'Date Night / Hosting', type: 'ctx-marriage' } }, powerMoves: [ { badge: 'Biz', text: 'Batch record content' }, { badge: 'Love', text: 'Prioritize intimacy' }, { badge: 'Fam', text: 'Host dinner/playdates' } ] },
            luteal: { name: 'Luteal (Autumn)', style: 'phase-luteal', focus: 'Finish & Organize', note: "Focus narrows. Finish open loops. Prepare household logistics. Spiritual consistency is key here.", adjustments: { morning: { task: 'Strength / Pilates', type: 'ctx-self' }, work1: { task: 'Deep Coding (Finishing)', type: 'ctx-biz' }, work2: { task: 'Organizing / SOPs', type: 'ctx-biz' }, evening: { task: 'Home Org / Prep', type: 'ctx-family' } }, powerMoves: [ { badge: 'Biz', text: 'Close open tickets/tasks' }, { badge: 'Home', text: 'Meal Prep & Declutter' }, { badge: 'Spirit', text: 'Consistent Prayer Routine' } ] }
        };

        function recalculateTrueCycle() {
            const inputDate = document.getElementById('lastPeriodInput').value;
            const startDate = new Date(inputDate);
            const today = new Date(); 
            const diffTime = Math.abs(today - startDate);
            let diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)); 
            
            trueDay = (diffDays % cycleLength) || cycleLength; 
            
            if (trueDay <= 5) truePhase = 'menstrual';
            else if (trueDay <= 12) truePhase = 'follicular';
            else if (trueDay <= 15) truePhase = 'ovulatory';
            else truePhase = 'luteal';

            const nextPeriod = new Date(startDate);
            nextPeriod.setDate(startDate.getDate() + cycleLength);
            document.getElementById('nextPeriodDate').textContent = nextPeriod.toLocaleDateString();

            displayPhase = truePhase;
            updateCycleUI(trueDay, truePhase);
            
            // Notification Logic: Check if we need to send an email for this phase
            checkAndSendNotification(truePhase, trueDay);

            document.querySelectorAll('.preview-btn').forEach(b => b.classList.remove('active-preview'));
            setSeason(currentSeason); 
        }

        /* --- EMAIL NOTIFICATION SYSTEM --- */
        async function checkAndSendNotification(phase, day) {
            // Only notify for Menstrual (Day 1) or Ovulatory (Entry into phase)
            if (phase !== 'menstrual' && phase !== 'ovulatory') return;

            // Use LocalStorage to prevent duplicate emails for the same entry in the same cycle
            const lastNotifiedEntry = localStorage.getItem('lastCycleNotified'); // Format: "phase-date"
            const todayKey = new Date().toDateString();
            const currentNotifKey = `${phase}-${todayKey}`;

            if (lastNotifiedEntry === currentNotifKey) {
                console.log(`Notification already sent for ${phase} today.`);
                return;
            }

            // If we are here, it's time to send
            const statusBox = document.getElementById('notificationStatusBox');
            const statusText = document.getElementById('notifStatusText');
            
            statusText.textContent = `Triggering ${phase} email alert...`;

            try {
                // Constructing content
                const subject = `Cycle Alert: You have entered the ${phase.toUpperCase()} phase`;
                const message = `Hello Shafira,\n\nThis is your Holistic CEO Dashboard alert.\n\nYou are currently on Day ${day} of your cycle (${phase}).\n\nFocus: ${cycleData[phase].focus}\nAdvice: ${cycleData[phase].note}\n\nCheck your dashboard for updated OKRs and Schedule.`;

                // In a real environment, you'd replace 'YOUR_FORMSPREE_ID_HERE' with your Formspree ID
                // To avoid sending actual network requests during testing, we log it.
                // UNCOMMENT the following lines when you have your Formspree ID:
                /*
                await fetch('https://formspree.io/f/xaqwwdrq', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        email: 'rafisha92@gmail.com',
                        subject: subject,
                        message: message
                    })
                });
                */

                console.log(`EMAIL SENT to rafisha92@gmail.com: ${subject}`);
                
                // Mark as notified
                localStorage.setItem('lastCycleNotified', currentNotifKey);
                
                statusText.textContent = `Alert sent to rafisha92@gmail.com for ${phase} phase entry.`;
                setTimeout(() => {
                    statusText.textContent = `Email alerts active for Menstruation & Ovulation to rafisha92@gmail.com`;
                }, 10000);

            } catch (err) {
                console.error("Email failed:", err);
                statusText.textContent = "Email notification failed. Check internet connection.";
            }
        }

        function previewPhase(phaseName) {
            displayPhase = phaseName;
            document.querySelectorAll('.preview-btn').forEach(b => b.classList.remove('active-preview'));
            event.target.classList.add('active-preview');
            let previewDay = 1;
            if (phaseName === 'follicular') previewDay = 7;
            if (phaseName === 'ovulatory') previewDay = 14;
            if (phaseName === 'luteal') previewDay = 20;
            updateCycleUI(previewDay, phaseName, true); 
            setSeason(currentSeason);
        }

        function updateCycleUI(day, phase, isPreview = false) {
            const data = cycleData[phase];
            const badgeClass = `cycle-phase-badge ${data.style}`;
            document.getElementById('headerPhaseBadge').className = badgeClass;
            document.getElementById('headerPhaseBadge').textContent = data.name + (isPreview ? " (Preview)" : "");
            document.getElementById('headerDayVal').textContent = day;
            document.getElementById('fullPhaseBadge').className = badgeClass;
            document.getElementById('fullPhaseBadge').textContent = data.name;
            const barWidth = (day / 28) * 100;
            document.getElementById('cycleBar').style.width = `${barWidth}%`;
        }

        function toggleWidget() {
            const body = document.getElementById('cycleBody');
            const icon = document.getElementById('widgetIcon');
            body.classList.toggle('collapsed');
            icon.classList.toggle('collapsed-icon');
        }

        function updateLifeStage() {
            currentLifeStage = document.getElementById('lifeStageSelect').value;
            setSeason(currentSeason);
        }

        /* --- 2. SEASON DATA --- */
        let currentSeason = 'nurture';

        const seasons = {
            nurture: {
                departments: [
                    { id: 'self', icon: 'üßò‚Äç‚ôÄÔ∏è', title: 'Self & Spirit', focus: 'Restoration', style: 'dept-self', okrs: ['KR: 4x Weekly Yoga/Pilates', 'KR: Daily Quran Journaling', 'KR: Sleep 7.5h avg'], win: 'Solo spiritual retreat day (local)' },
                    { id: 'marriage', icon: 'üíë', title: 'Marriage & Home', focus: 'Reconnection', style: 'dept-marriage', okrs: ['KR: Weekly Logistics Sync (Sun)', 'KR: Host 1 Calm Dinner', 'KR: Monthly In-laws Visit', 'KR: Pray Together Weekly'], win: 'Recreate our first date menu at home' },
                    { id: 'biz', icon: 'üíº', title: 'Cetalabs', focus: 'Stability (25h)', style: 'dept-biz', okrs: ['KR: Set "Niat" before work', 'KR: Retain Members', 'KR: Maintenance Dev Only'], win: 'Record a "Founder Journey" reflection vlog' },
                    { id: 'visibility', icon: 'üé§', title: 'Visibility', focus: 'Low-Lift', style: 'dept-visibility', okrs: ['KR: Guest on 1 Podcast', 'KR: Write 1 LinkedIn article'], win: 'Get featured in a niche newsletter' },
                    { id: 'impact', icon: 'üåç', title: 'Impact & Cause', focus: 'Automated Giving', style: 'dept-impact', okrs: ['KR: Automate Monthly Donation', 'KR: Mentor 1 Junior (Async)'], win: 'Sponsor a student/family anonymously' }
                ],
                baseSchedule: [
                    { time: '6:30 AM', slot: 'morning' },
                    { time: '8:30 AM', activity: 'Life Stage Routine', tag: 'Flex', style: 'ctx-baby' },
                    { time: '10:00 AM', slot: 'work1' },
                    { time: '12:00 PM', activity: 'Lunch & Nap/Prayer', tag: 'Rest', style: 'ctx-self' },
                    { time: '2:00 PM', slot: 'work2' },
                    { time: '4:30 PM', activity: 'Park/Family', tag: 'Family', style: 'ctx-family' },
                    { time: '8:00 PM', slot: 'evening' }
                ],
                weekly: [ { badge: 'Biz', text: 'Finance Review' }, { badge: 'Spirit', text: 'Friday Surah Kahf' }, { badge: 'Home', text: 'Logistics Sync w/ Husband' } ],
                monthly: [ { badge: 'Fam', text: 'Visit Big Family' }, { badge: 'Life', text: 'Milestone Review' } ]
            },
            balance: {
                departments: [
                    { id: 'self', icon: 'üßò‚Äç‚ôÄÔ∏è', title: 'Self & Spirit', focus: 'Maintenance', style: 'dept-self', okrs: ['KR: 3x Workout', 'KR: Daily Meditation/Dhikr', 'KR: Read 1 Spiritual Book'], win: 'Finish one spiritual book & summarize' },
                    { id: 'marriage', icon: 'üíë', title: 'Marriage & Home', focus: 'Partnership', style: 'dept-marriage', okrs: ['KR: Bi-weekly Date Night', 'KR: Visit Parents Bi-weekly', 'KR: Host 1 Social Gathering'], win: 'Weekend getaway or staycation' },
                    { id: 'biz', icon: 'üíº', title: 'Cetalabs', focus: 'Growth (30h)', style: 'dept-biz', okrs: ['KR: Ethical Decisions', 'KR: Grow Users', 'KR: 2 Content/wk'], win: 'Launch a community challenge' },
                    { id: 'visibility', icon: 'üé§', title: 'Visibility', focus: 'Local Authority', style: 'dept-visibility', okrs: ['KR: Host 1 Local Workshop', 'KR: Attend 1 Networking Event'], win: 'Speak on a panel or webinar' },
                    { id: 'impact', icon: 'üåç', title: 'Impact', focus: 'Participation', style: 'dept-impact', okrs: ['KR: 1 Volunteer Day', 'KR: Pro-bono Consult'], win: 'Organize a charity drive' }
                ],
                baseSchedule: [
                    { time: '6:30 AM', slot: 'morning' },
                    { time: '9:00 AM', slot: 'work1' },
                    { time: '12:30 PM', activity: 'Lunch & Life Stage', tag: 'Flex', style: 'ctx-baby' },
                    { time: '2:00 PM', slot: 'work2' },
                    { time: '5:00 PM', activity: 'Shut Down', tag: 'Boundaries', style: 'ctx-self' },
                    { time: '8:30 PM', slot: 'evening' }
                ],
                weekly: [ { badge: 'Home', text: 'Meal Prep Sync' }, { badge: 'Love', text: 'Sunday Planning' } ],
                monthly: [ { badge: 'Fam', text: 'Extended Family Outing' }, { badge: 'Life', text: 'Toy/Space Rotation' } ]
            },
            sprint: {
                departments: [
                    { id: 'self', icon: 'üßò‚Äç‚ôÄÔ∏è', title: 'Self & Spirit', focus: 'Min. Dose', style: 'dept-self', okrs: ['KR: 15m Prayer/Dhikr', 'KR: 10pm Sleep', 'KR: 15m Movement'], win: '30-day gratitude journal' },
                    { id: 'marriage', icon: 'üíë', title: 'Marriage & Home', focus: 'Support', style: 'dept-marriage', okrs: ['KR: Monthly Date', 'KR: Outsourced Cleaning', 'KR: Daily Connect'], win: 'Surprise gift for spouse' },
                    { id: 'biz', icon: 'üíº', title: 'Cetalabs', focus: 'Scale (35h+)', style: 'dept-biz', okrs: ['KR: Donate % of Profit', 'KR: Hire VA', 'KR: 2 Corp Deals'], win: 'Close a major partnership' },
                    { id: 'visibility', icon: 'üé§', title: 'Visibility', focus: 'Thought Leadership', style: 'dept-visibility', okrs: ['KR: Keynote/Major Conf', 'KR: Launch PR Campaign'], win: 'Major industry interview' },
                    { id: 'impact', icon: 'üåç', title: 'Impact', focus: 'Strategic Giving', style: 'dept-impact', okrs: ['KR: Launch Scholarship', 'KR: Fundraising Event'], win: 'Fund a community project' }
                ],
                baseSchedule: [
                    { time: '6:00 AM', slot: 'morning' },
                    { time: '8:00 AM', activity: 'Life Stage Prep', tag: 'Family', style: 'ctx-baby' },
                    { time: '10:00 AM', slot: 'work1' },
                    { time: '2:00 PM', slot: 'work2' },
                    { time: '5:00 PM', activity: 'Disconnect', tag: 'Family', style: 'ctx-family' },
                    { time: '9:00 PM', slot: 'evening' }
                ],
                weekly: [ { badge: 'Biz', text: 'Sales Calls (3)' }, { badge: 'Home', text: 'Cleaner Visit' } ],
                monthly: [ { badge: 'Biz', text: 'Corp Pitch' }, { badge: 'Love', text: 'Quality Dinner Out' } ]
            }
        };

        function setSeason(season) {
            currentSeason = season;
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            const activeBtn = document.querySelector(`.tab-${season}`);
            if (activeBtn) activeBtn.classList.add('active');

            const data = seasons[season];
            const cData = cycleData[displayPhase];
            
            const currentLifeData = lifeStageData[currentLifeStage];
            let displayDepts = [...data.departments];
            displayDepts.splice(1, 0, currentLifeData);

            const deptHTML = displayDepts.map(d => `
                <div class="dept-card ${d.style}">
                    <div>
                        <span class="dept-icon">${d.icon}</span>
                        <div class="dept-title">${d.title}</div>
                        <span class="dept-focus">${d.focus}</span>
                        <ul class="dept-okr-list">
                            ${d.okrs.map(o => `<li>${o}</li>`).join('')}
                        </ul>
                    </div>
                    <div class="creative-win-box">
                        <span class="win-title">‚ú® Suggestive Win</span>
                        <span class="win-text">"${d.win || 'Plan something special'}"</span>
                    </div>
                </div>
            `).join('');
            document.getElementById('deptContainer').innerHTML = deptHTML;

            document.getElementById('cycleNote').innerHTML = `<strong>${cData.name} Phase Tip:</strong> ${cData.note}`;
            
            const timeHTML = data.baseSchedule.map(s => {
                if (s.slot) {
                    const adjustment = cData.adjustments[s.slot];
                    return `
                        <div class="time-card ${adjustment.type} adjusted">
                            <span class="time-label">${s.time}</span>
                            <div class="time-activity">${adjustment.task}</div>
                            <span class="time-tag">Bio-Sync</span>
                        </div>
                    `;
                } else {
                    return `
                        <div class="time-card ${s.style}">
                            <span class="time-label">${s.time}</span>
                            <div class="time-activity">${s.activity}</div>
                            <span class="time-tag">${s.tag}</span>
                        </div>
                    `;
                }
            }).join('');
            document.getElementById('timeGrid').innerHTML = timeHTML;

            const renderList = (items) => items.map(i => `
                <div class="cl-item">
                    <span class="cl-badge">${i.badge}</span>
                    <span>${i.text}</span>
                </div>
            `).join('');

            document.getElementById('weeklyList').innerHTML = renderList(data.weekly);
            document.getElementById('monthlyList').innerHTML = renderList(data.monthly);
            document.getElementById('cycleProtocolList').innerHTML = renderList(cData.powerMoves);
        }

        // Init
        recalculateTrueCycle();
    </script>
    <script>
        // --- EMAILJS CONFIG ---
        // IMPORTANT: Replace with your actual IDs from EmailJS Dashboard
        const EMAILJS_PUBLIC_KEY = "EONydXun8_CTmWkl7"; // Enter Public Key
        const EMAILJS_SERVICE_ID = "service_87zo2da"; 
        const EMAILJS_TEMPLATE_ID = "template_942d8wt"; // Enter Template ID
        const RECIPIENT_EMAIL = "nshfnoh@proton.me";

        if (EMAILJS_PUBLIC_KEY) emailjs.init(EMAILJS_PUBLIC_KEY);

        /* --- STATE & LOGIC --- */
        let truePhase = 'menstrual'; 
        let displayPhase = 'menstrual'; 
        let trueDay = 1;
        let currentLifeStage = 'parenting'; 
        const cycleLength = 28;
        let currentSeason = 'nurture';

        const lifeStageData = {
            preparing: { id: 'baby', icon: 'üå±', title: 'Preparing', focus: 'Health & Calm', style: 'dept-baby', okrs: ['KR: Daily Folic Acid & Supps', 'KR: Track Cycle Consistently'], win: 'Book a couples spa day' },
            pregnancy: { id: 'baby', icon: 'ü§∞', title: 'Pregnancy', focus: 'Nesting & Health', style: 'dept-baby', okrs: ['KR: Hypnobirthing Course', 'KR: Nursery Setup'], win: 'Start a pregnancy journal' },
            parenting: { id: 'baby', icon: 'üë∂', title: 'Parenting', focus: 'Connection & Guide', style: 'dept-baby', okrs: ['KR: Daily Sensory Play', 'KR: Toy Rotation'], win: 'Create a Photo Book' },
            parenting_pregnant: { id: 'baby', icon: 'ü§±', title: 'Parenting + Pregnant', focus: 'Energy Management', style: 'dept-baby', okrs: ['KR: Sibling Prep Books', 'KR: Outsource Lifting'], win: 'Pack Sibling gift box' }
        };

        const cycleData = {
            menstrual: { name: 'Menstrual (Winter)', style: 'phase-menstrual', focus: 'Rest & Spiritual Reflection', note: "Energy is lowest. Prioritize spiritual grounding (Dhikr/Journaling) and deep rest.", color: '#be185d', emoji: '‚ùÑÔ∏è', adjustments: { morning: { task: 'Gentle Stretch', type: 'ctx-self' }, work1: { task: 'Admin (Low Energy)', type: 'ctx-biz' }, work2: { task: 'Reading', type: 'ctx-biz' }, evening: { task: 'Early Bedtime', type: 'ctx-self' } }, powerMoves: [{badge: 'Spirit', text: 'Increase Dhikr'}] },
            follicular: { name: 'Follicular (Spring)', style: 'phase-follicular', focus: 'Plan & Create', note: "Energy rising. Great for brainstorming new features and planning family outings.", color: '#15803d', emoji: 'üå±', adjustments: { morning: { task: 'Cardio', type: 'ctx-self' }, work1: { task: 'Creative Code', type: 'ctx-biz' }, work2: { task: 'Planning', type: 'ctx-biz' }, evening: { task: 'Family Fun', type: 'ctx-family' } }, powerMoves: [{badge: 'Biz', text: 'New features'}] },
            ovulatory: { name: 'Ovulatory (Summer)', style: 'phase-ovulatory', focus: 'Connect & Pitch', note: "Peak energy & magnetism. Host gatherings, pitch clients, and prioritize connection with husband.", color: '#a16207', emoji: '‚òÄÔ∏è', adjustments: { morning: { task: 'HIIT Power', type: 'ctx-self' }, work1: { task: 'Sales Calls', type: 'ctx-biz' }, work2: { task: 'Meetings', type: 'ctx-biz' }, evening: { task: 'Date Night', type: 'ctx-marriage' } }, powerMoves: [{badge: 'Love', text: 'Prioritize intimacy'}] },
            luteal: { name: 'Luteal (Autumn)', style: 'phase-luteal', focus: 'Finish & Organize', note: "Focus narrows. Finish open loops. Prepare household logistics. Spiritual consistency is key here.", color: '#c2410c', emoji: 'üçÇ', adjustments: { morning: { task: 'Strength', type: 'ctx-self' }, work1: { task: 'Deep Coding', type: 'ctx-biz' }, work2: { task: 'Organizing', type: 'ctx-biz' }, evening: { task: 'Home Prep', type: 'ctx-family' } }, powerMoves: [{badge: 'Home', text: 'Meal Prep'}] }
        };

        const seasons = {
            nurture: {
                departments: [
                    { id: 'self', icon: 'üßò‚Äç‚ôÄÔ∏è', title: 'Self & Spirit', focus: 'Restoration', style: 'dept-self', okrs: ['KR: 4x Weekly Yoga', 'KR: Daily Quran Journaling'], win: 'Solo spiritual retreat' },
                    { id: 'marriage', icon: 'üíë', title: 'Marriage & Home', focus: 'Reconnection', style: 'dept-marriage', okrs: ['KR: Weekly Logistics Sync', 'KR: Host 1 Calm Dinner'], win: 'Home-cooked first date menu' },
                    { id: 'biz', icon: 'üíº', title: 'Cetalabs', focus: 'Stability', style: 'dept-biz', okrs: ['KR: Retain Members', 'KR: Maintenance Only'], win: 'Founder Reflection vlog' }
                ],
                baseSchedule: [
                    { time: '6:30 AM', slot: 'morning' },
                    { time: '10:00 AM', slot: 'work1' },
                    { time: '2:00 PM', slot: 'work2' },
                    { time: '8:00 PM', slot: 'evening' }
                ],
                weekly: [], monthly: []
            }
        };

        function recalculateTrueCycle() {
            const inputDate = document.getElementById('lastPeriodInput').value;
            const startDate = new Date(inputDate);
            const today = new Date(); 
            const diffTime = today - startDate;
            let diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24)) + 1;
            
            trueDay = ((diffDays - 1) % cycleLength) + 1;
            
            if (trueDay <= 5) truePhase = 'menstrual';
            else if (trueDay <= 12) truePhase = 'follicular';
            else if (trueDay <= 15) truePhase = 'ovulatory';
            else truePhase = 'luteal';

            const nextPeriod = new Date(startDate);
            nextPeriod.setDate(startDate.getDate() + cycleLength);
            document.getElementById('nextPeriodDate').textContent = nextPeriod.toLocaleDateString();

            displayPhase = truePhase;
            updateCycleUI(trueDay, truePhase);
            checkAutoEmailTriggers(truePhase, trueDay);
            setSeason(currentSeason); 
        }

        /* --- PARTNER SYNC EMAIL ENGINE --- */
        async function sendCycleEmail(phaseKey, day, isManual = false) {
            const phase = cycleData[phaseKey];
            const btn = document.getElementById('manualSyncBtn');
            const statusText = document.getElementById('syncStatusText');

            if (isManual) {
                btn.disabled = true;
                btn.textContent = "Sending...";
            }

            // Calculate the specific date for this cycle day relative to the period start date
            const startDateInput = document.getElementById('lastPeriodInput').value;
            const startDateObj = new Date(startDateInput);
            const contentDateObj = new Date(startDateObj);
            contentDateObj.setDate(startDateObj.getDate() + (day - 1));
            
            // Format dates for display in the email and subject line
            const formattedDateFull = contentDateObj.toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
            const shortDateForSubject = contentDateObj.toLocaleDateString('en-US', { day: 'numeric', month: 'long' });
            
            const supportTips = getSupportTips(phaseKey);

            // GENERATE HTML BODY INTERNALLY
            const emailHtml = `
                <div style="font-family: sans-serif; background-color: #fafaf9; padding: 20px; color: #334155;">
                    <div style="max-width: 600px; margin: 0 auto; background: white; border-radius: 20px; overflow: hidden; border: 1px solid #fee2e2;">
                        <div style="background: linear-gradient(135deg, #fff1f2 0%, #fff7ed 100%); padding: 30px; text-align: center; border-bottom: 1px solid #fff1f2;">
                            <span style="font-size: 40px;">${phase.emoji}</span>
                        </div>
                        <div style="padding: 30px;">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 20px;">
                                <div>
                                    <h1 style="color: #881337; font-size: 24px; margin: 0;">Cycle Update</h1>
                                    <p style="color: #fb7185; margin: 5px 0;">${formattedDateFull}</p>
                                </div>
                                <div style="background: #fff1f2; padding: 5px 15px; border-radius: 20px; border: 1px solid #ffe4e6; height: fit-content;">
                                    <span style="color: #e11d48; font-weight: bold; font-size: 12px; text-transform: uppercase;">Phase: ${phase.name}</span>
                                </div>
                            </div>
                            <p style="font-size: 16px; line-height: 1.6;">Hi R, just a heads up on my biology status for this specific date. Here's a quick briefing for this phase.</p>
                            <div style="background: #f8fafc; border-radius: 15px; padding: 20px; border: 1px solid #f1f5f9; margin: 20px 0;">
                                <h2 style="font-size: 16px; color: #0f172a; margin-top: 0;">üí° Briefing for R</h2>
                                <ul style="list-style: none; padding: 0;">
                                    <li style="margin-bottom: 15px; display: flex; align-items: flex-start;">
                                        <span style="color: #fb7185; font-weight: bold; margin-right: 10px;">‚Ä¢</span>
                                        <span><strong>Energy Level:</strong> ${phase.note}</span>
                                    </li>
                                    <li style="margin-bottom: 15px; display: flex; align-items: flex-start;">
                                        <span style="color: #fb7185; font-weight: bold; margin-right: 10px;">‚Ä¢</span>
                                        <span><strong>Focus:</strong> ${phase.focus}</span>
                                    </li>
                                    <li style="margin-bottom: 0; display: flex; align-items: flex-start;">
                                        <span style="color: #fb7185; font-weight: bold; margin-right: 10px;">‚Ä¢</span>
                                        <span><strong>Support Moves:</strong> ${supportTips}</span>
                                    </li>
                                </ul>
                            </div>
                            <p style="text-align: center; font-style: italic; color: #64748b; margin-top: 30px;">"Thank you for being my partner through every season."</p>
                        </div>
                    </div>
                </div>
            `;

            const templateParams = {
                to_email: RECIPIENT_EMAIL,
                subject: `Cycle Update: ${phase.name} - ${shortDateForSubject}`,
                email_html: emailHtml
            };

            try {
                if (!EMAILJS_PUBLIC_KEY || !EMAILJS_TEMPLATE_ID) {
                    console.log("PREVIEW EMAIL (Copy HTML from Console):", templateParams);
                    if (isManual) {
                        statusText.textContent = `‚úÖ Subject: ${templateParams.subject}`;
                        setTimeout(() => statusText.textContent = "Emails R on Day 1, Ovulation & Day 23", 4000);
                    }
                } else {
                    await emailjs.send(EMAILJS_SERVICE_ID, EMAILJS_TEMPLATE_ID, templateParams);
                }
                
                if (isManual) {
                    btn.textContent = "‚úÖ Sent to R";
                    setTimeout(() => {
                        btn.disabled = false;
                        btn.textContent = "‚úâÔ∏è Send Update to R Now";
                    }, 3000);
                }
            } catch (err) {
                console.error("Email Error:", err);
                if (isManual) {
                    btn.textContent = "‚ùå Error";
                    btn.disabled = false;
                }
            }
        }

        function getSupportTips(phase) {
            const tips = {
                menstrual: "Warm drinks, low-pressure evenings, heating pad, extra rest. Grace and patience are my favorite gifts.",
                follicular: "I'm feeling creative! Let's plan something new or go on a small adventure.",
                ovulatory: "Date night! I have high energy and magnetism right now. Great time for social outings.",
                luteal: "Grace and patience are key. Help with home logistics/meal prep. I need early, quiet nights."
            };
            return tips[phase] || "Just extra love today.";
        }

        function checkAutoEmailTriggers(phase, day) {
            const isAutoEnabled = document.getElementById('autoSyncToggle').checked;
            if (!isAutoEnabled) return;

            const todayKey = new Date().toISOString().split('T')[0];
            const lastSent = localStorage.getItem('lastAutoEmailDate');
            const lastSentDay = localStorage.getItem('lastAutoEmailDay');

            const triggerDays = [1, 13, 14, 23];
            
            if (triggerDays.includes(day) && (lastSent !== todayKey || lastSentDay != day)) {
                sendCycleEmail(phase, day, false);
                localStorage.setItem('lastAutoEmailDate', todayKey);
                localStorage.setItem('lastAutoEmailDay', day);
            }
        }

        function sendManualUpdate() {
            sendCycleEmail(displayPhase, trueDay, true);
        }

        function saveSyncPrefs() {
            localStorage.setItem('autoSyncEnabled', document.getElementById('autoSyncToggle').checked);
        }

        /* --- UI UPDATES --- */
        function updateCycleUI(day, phase, isPreview = false) {
            const data = cycleData[phase];
            const badgeClass = `cycle-phase-badge ${data.style}`;
            document.getElementById('headerPhaseBadge').className = badgeClass;
            document.getElementById('headerPhaseBadge').textContent = data.name + (isPreview ? " (Preview)" : "");
            document.getElementById('headerDayVal').textContent = day;
            document.getElementById('fullPhaseBadge').className = badgeClass;
            document.getElementById('fullPhaseBadge').textContent = data.name;
            const barWidth = (day / 28) * 100;
            document.getElementById('cycleBar').style.width = `${barWidth}%`;
        }

        function previewPhase(phaseName) {
            displayPhase = phaseName;
            document.querySelectorAll('.preview-btn').forEach(b => b.classList.remove('active-preview'));
            event.target.classList.add('active-preview');
            // When previewing, we update the trueDay temporarily for the email logic if manual button is clicked
            if (phaseName === 'menstrual') trueDay = 1;
            else if (phaseName === 'follicular') trueDay = 7;
            else if (phaseName === 'ovulatory') trueDay = 14;
            else if (phaseName === 'luteal') trueDay = 22;
            
            updateCycleUI(trueDay, phaseName, true); 
            setSeason(currentSeason);
        }

        function toggleWidget() {
            const body = document.getElementById('cycleBody');
            body.classList.toggle('collapsed');
        }

        function updateLifeStage() {
            currentLifeStage = document.getElementById('lifeStageSelect').value;
            setSeason(currentSeason);
        }

        function setSeason(season) {
            currentSeason = season;
            const data = seasons['nurture'];
            const cData = cycleData[displayPhase];
            const currentLifeData = lifeStageData[currentLifeStage];
            
            let displayDepts = [...data.departments];
            displayDepts.splice(1, 0, currentLifeData);

            document.getElementById('deptContainer').innerHTML = displayDepts.map(d => `
                <div class="dept-card ${d.style}">
                    <span class="dept-icon">${d.icon}</span>
                    <div class="dept-title">${d.title}</div>
                    <span class="dept-focus">${d.focus}</span>
                    <ul class="dept-okr-list">${d.okrs.map(o => `<li>${o}</li>`).join('')}</ul>
                    <div class="creative-win-box"><span class="win-title">‚ú® Win</span><span class="win-text">"${d.win}"</span></div>
                </div>
            `).join('');

            document.getElementById('timeGrid').innerHTML = data.baseSchedule.map(s => {
                const adj = cData.adjustments[s.slot] || {task: s.activity, type: s.style};
                return `
                    <div class="time-card ${adj.type}">
                        <span class="time-label">${s.time}</span>
                        <div class="time-activity">${adj.task}</div>
                    </div>
                `;
            }).join('');
        }

        // Init
        const storedSync = localStorage.getItem('autoSyncEnabled');
        if (storedSync !== null) document.getElementById('autoSyncToggle').checked = (storedSync === 'true');
        recalculateTrueCycle();
    </script>
</body>
</html>
